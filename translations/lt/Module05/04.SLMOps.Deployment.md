<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "ad0c054ebd3de404d997d1707a513c70",
  "translation_date": "2025-09-19T01:21:15+00:00",
  "source_file": "Module05/04.SLMOps.Deployment.md",
  "language_code": "lt"
}
-->
# 4 skyrius: Diegimas - ParuoÅ¡to modelio Ä¯gyvendinimas

## ApÅ¾valga

Å i iÅ¡sami pamoka padÄ—s jums pereiti visÄ… procesÄ…, kaip diegti pritaikytus kvantizuotus modelius naudojant Foundry Local. ApÅ¾velgsime modelio konvertavimÄ…, kvantizavimo optimizavimÄ… ir diegimo konfigÅ«racijÄ… nuo pradÅ¾ios iki pabaigos.

## BÅ«tinos sÄ…lygos

PrieÅ¡ pradÄ—dami, Ä¯sitikinkite, kad turite:

- âœ… PritaikytÄ… ONNX modelÄ¯, paruoÅ¡tÄ… diegimui
- âœ… Windows arba Mac kompiuterÄ¯
- âœ… Python 3.10 ar naujesnÄ™ versijÄ…
- âœ… Bent 8GB laisvos RAM
- âœ… Ä®diegtÄ… Foundry Local jÅ«sÅ³ sistemoje

## 1 dalis: Aplinkos paruoÅ¡imas

### ReikalingÅ³ Ä¯rankiÅ³ diegimas

Atidarykite terminalÄ… (Command Prompt Windows sistemoje, Terminal Mac sistemoje) ir vykdykite Å¡ias komandas iÅ¡ eilÄ—s:

```bash
# Update transformers library to the latest version
pip install transformers -U

# Install Microsoft Olive (model conversion tool)
pip install git+https://github.com/microsoft/Olive.git

# Install ONNX Runtime GenAI
git clone https://github.com/microsoft/onnxruntime-genai
cd onnxruntime-genai && python build.py --config Release
pip install {Your build release path}/onnxruntime_genai-0.9.0.dev0-cp311-cp311-linux_x86_64.whl

# Install additional dependencies
pip install onnx onnxruntime numpy
```

âš ï¸ **Svarbi pastaba**: Jums taip pat reikÄ—s CMake 3.31 ar naujesnÄ—s versijos, kuriÄ… galite atsisiÅ³sti iÅ¡ [cmake.org](https://cmake.org/download/).

## 2 dalis: Modelio konvertavimas ir kvantizavimas

### Tinkamo formato pasirinkimas

Pritaikytiems maÅ¾iems kalbos modeliams rekomenduojame naudoti **ONNX formatÄ…**, nes jis siÅ«lo:

- ğŸš€ GeresnÄ™ naÅ¡umo optimizacijÄ…
- ğŸ”§ AparatÅ«ros nepriklausomÄ… diegimÄ…
- ğŸ­ ParuoÅ¡tumÄ… gamybai
- ğŸ“± SuderinamumÄ… su Ä¯vairiomis platformomis

### 1 metodas: Konvertavimas viena komanda (Rekomenduojama)

Naudokite Å¡iÄ… komandÄ…, kad tiesiogiai konvertuotumÄ—te pritaikytÄ… modelÄ¯:

```bash
olive auto-opt \
    --model_name_or_path /path/to/your/finetuned/model \
    --device cpu \
    --provider CPUExecutionProvider \
    --use_model_builder \
    --precision int4 \
    --output_path models/your-model-name/onnx \
    --log_level 1
```

**ParametrÅ³ paaiÅ¡kinimas:**
- `--model_name_or_path`: Kelias iki jÅ«sÅ³ pritaikyto modelio
- `--device cpu`: Naudoti CPU optimizavimui
- `--precision int4`: Naudoti INT4 kvantizavimÄ… (maÅ¾daug 75% dydÅ¾io sumaÅ¾inimas)
- `--output_path`: IÅ¡vesties kelias konvertuotam modeliui

### 2 metodas: KonfigÅ«racijos failo metodas (Patyrusiems vartotojams)

Sukurkite konfigÅ«racijos failÄ… pavadinimu `finetuned_conversion_config.json`:

```json
{
    "input_model": {
        "type": "HfModel",
        "model_path": "/path/to/your/finetuned/model",
        "task": "text-generation"
    },
    "systems": {
        "local_system": {
            "type": "LocalSystem",
            "accelerators": [
                {
                    "execution_providers": [
                        "CPUExecutionProvider"
                    ]
                }
            ]
        }
    },
    "passes": {
        "builder": {
            "type": "ModelBuilder",
            "config": {
                "precision": "int4",
                "quantization_config": {
                    "block_size": 128,
                    "is_symmetric": false
                }
            }
        }
    },
    "host": "local_system",
    "target": "local_system",
    "cache_dir": "cache",
    "output_dir": "models/output/your-finetuned-model-onnx"
}
```

Tada vykdykite:

```bash
olive run --config ./finetuned_conversion_config.json
```

### Kvantizavimo parinkÄiÅ³ palyginimas

| Tikslumas | Failo dydis | Ä®Å¾valgos greitis | Modelio kokybÄ— | Rekomenduojamas naudojimas |
|-----------|-------------|------------------|----------------|----------------------------|
| FP16      | Bazinis Ã— 0.5 | Greitas | Geriausias | AukÅ¡tos klasÄ—s aparatinÄ— Ä¯ranga |
| INT8      | Bazinis Ã— 0.25 | Labai greitas | Geras | Subalansuotas pasirinkimas |
| INT4      | Bazinis Ã— 0.125 | GreiÄiausias | Priimtinas | Riboti resursai |

ğŸ’¡ **Rekomendacija**: Pirmam diegimui pradÄ—kite nuo INT4 kvantizavimo. Jei kokybÄ— nÄ—ra patenkinama, iÅ¡bandykite INT8 arba FP16.

## 3 dalis: Foundry Local diegimo konfigÅ«racija

### Modelio konfigÅ«racijos kÅ«rimas

Eikite Ä¯ Foundry Local modeliÅ³ katalogÄ…:

```bash
foundry cache cd ./models/
```

Sukurkite modelio katalogo struktÅ«rÄ…:

```bash
mkdir -p ./models/custom/your-finetuned-model
```

Sukurkite `inference_model.json` konfigÅ«racijos failÄ… savo modelio kataloge:

```json
{
  "Name": "your-finetuned-model-int4",
  "Description": "Fine-tuned quantized model",
  "Version": "1.0",
  "PromptTemplate": {
    "system": "<|im_start|>system\n{Content}<|im_end|>",
    "user": "<|im_start|>user\n{Content}<|im_end|>",
    "assistant": "<|im_start|>assistant\n{Content}<|im_end|>",
    "prompt": "<|im_start|>user\n{Content}<|im_end|>\n<|im_start|>assistant"
  },
  "ModelConfig": {
    "max_length": 2048,
    "temperature": 0.7,
    "top_p": 0.9,
    "repetition_penalty": 1.1
  }
}
```

### Modelio Å¡ablonÅ³ konfigÅ«racijos

#### Qwen serijos modeliams:

```json
{
  "Name": "qwen-finetuned-int4",
  "PromptTemplate": {
    "system": "<|im_start|>system\n{Content}<|im_end|>",
    "user": "<|im_start|>user\n{Content}<|im_end|>",
    "assistant": "<|im_start|>assistant\n{Content}<|im_end|>",
    "prompt": "<|im_start|>user\n{Content}<|im_end|>\n<|im_start|>assistant"
  }
}
```

## 4 dalis: Modelio testavimas ir optimizavimas

### Modelio diegimo patikrinimas

Patikrinkite, ar Foundry Local atpaÅ¾Ä¯sta jÅ«sÅ³ modelÄ¯:

```bash
foundry cache ls
```

TurÄ—tumÄ—te matyti `your-finetuned-model-int4` sÄ…raÅ¡e.

### Modelio testavimo pradÅ¾ia

```bash
foundry model run your-finetuned-model-int4
```

### NaÅ¡umo vertinimas

StebÄ—kite pagrindinius rodiklius testavimo metu:

1. **Atsako laikas**: Vidutinio atsako laiko matavimas
2. **Atminties naudojimas**: RAM sunaudojimo stebÄ—jimas
3. **CPU apkrova**: Procesoriaus apkrovos tikrinimas
4. **IÅ¡vesties kokybÄ—**: AtsakymÅ³ aktualumo ir nuoseklumo vertinimas

### KokybÄ—s patikrinimo kontrolinis sÄ…raÅ¡as

- âœ… Modelis tinkamai reaguoja Ä¯ pritaikytos srities uÅ¾klausas
- âœ… AtsakymÅ³ formatas atitinka numatytÄ… iÅ¡vesties struktÅ«rÄ…
- âœ… NÄ—ra atminties nutekÄ—jimÅ³ ilgalaikio naudojimo metu
- âœ… Nuoseklus naÅ¡umas skirtingo ilgio Ä¯vestims
- âœ… Tinkamas kraÅ¡tutiniÅ³ atvejÅ³ ir neteisingÅ³ Ä¯vestÅ³ duomenÅ³ apdorojimas

## Santrauka

Sveikiname! JÅ«s sÄ—kmingai atlikote:

- âœ… Pritaikyto modelio formato konvertavimÄ…
- âœ… Modelio kvantizavimo optimizavimÄ…
- âœ… Foundry Local diegimo konfigÅ«racijÄ…
- âœ… NaÅ¡umo derinimÄ… ir problemÅ³ sprendimÄ…

---

**AtsakomybÄ—s apribojimas**:  
Å is dokumentas buvo iÅ¡verstas naudojant AI vertimo paslaugÄ… [Co-op Translator](https://github.com/Azure/co-op-translator). Nors siekiame tikslumo, praÅ¡ome atkreipti dÄ—mesÄ¯, kad automatiniai vertimai gali turÄ—ti klaidÅ³ ar netikslumÅ³. Originalus dokumentas jo gimtÄ…ja kalba turÄ—tÅ³ bÅ«ti laikomas autoritetingu Å¡altiniu. Kritinei informacijai rekomenduojama profesionali Å¾mogaus vertimo paslauga. Mes neprisiimame atsakomybÄ—s uÅ¾ nesusipratimus ar klaidingus interpretavimus, atsiradusius dÄ—l Å¡io vertimo naudojimo.
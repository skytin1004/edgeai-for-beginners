<!--
CO_OP_TRANSLATOR_METADATA:
{
  "original_hash": "ad0c054ebd3de404d997d1707a513c70",
  "translation_date": "2025-09-18T13:05:36+00:00",
  "source_file": "Module05/04.SLMOps.Deployment.md",
  "language_code": "vi"
}
-->
# Pháº§n 4: Triá»ƒn khai - Thá»±c hiá»‡n mÃ´ hÃ¬nh sáºµn sÃ ng cho sáº£n xuáº¥t

## Tá»•ng quan

HÆ°á»›ng dáº«n toÃ n diá»‡n nÃ y sáº½ giÃºp báº¡n thá»±c hiá»‡n toÃ n bá»™ quy trÃ¬nh triá»ƒn khai cÃ¡c mÃ´ hÃ¬nh Ä‘Ã£ tinh chá»‰nh vÃ  lÆ°á»£ng tá»­ hÃ³a báº±ng Foundry Local. ChÃºng ta sáº½ Ä‘i qua cÃ¡c bÆ°á»›c chuyá»ƒn Ä‘á»•i mÃ´ hÃ¬nh, tá»‘i Æ°u hÃ³a lÆ°á»£ng tá»­ hÃ³a, vÃ  cáº¥u hÃ¬nh triá»ƒn khai tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i.

## YÃªu cáº§u trÆ°á»›c

TrÆ°á»›c khi báº¯t Ä‘áº§u, hÃ£y Ä‘áº£m báº£o báº¡n cÃ³ cÃ¡c Ä‘iá»u kiá»‡n sau:

- âœ… Má»™t mÃ´ hÃ¬nh onnx Ä‘Ã£ tinh chá»‰nh, sáºµn sÃ ng Ä‘á»ƒ triá»ƒn khai
- âœ… MÃ¡y tÃ­nh Windows hoáº·c Mac
- âœ… Python 3.10 hoáº·c cao hÆ¡n
- âœ… Ãt nháº¥t 8GB RAM kháº£ dá»¥ng
- âœ… Foundry Local Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t trÃªn há»‡ thá»‘ng cá»§a báº¡n

## Pháº§n 1: Thiáº¿t láº­p mÃ´i trÆ°á»ng

### CÃ i Ä‘áº·t cÃ¡c cÃ´ng cá»¥ cáº§n thiáº¿t

Má»Ÿ terminal cá»§a báº¡n (Command Prompt trÃªn Windows, Terminal trÃªn Mac) vÃ  cháº¡y cÃ¡c lá»‡nh sau theo thá»© tá»±:

```bash
# Update transformers library to the latest version
pip install transformers -U

# Install Microsoft Olive (model conversion tool)
pip install git+https://github.com/microsoft/Olive.git

# Install ONNX Runtime GenAI
git clone https://github.com/microsoft/onnxruntime-genai
cd onnxruntime-genai && python build.py --config Release
pip install {Your build release path}/onnxruntime_genai-0.9.0.dev0-cp311-cp311-linux_x86_64.whl

# Install additional dependencies
pip install onnx onnxruntime numpy
```

âš ï¸ **LÆ°u Ã½ quan trá»ng**: Báº¡n cÅ©ng cáº§n CMake phiÃªn báº£n 3.31 hoáº·c má»›i hÆ¡n, cÃ³ thá»ƒ táº£i xuá»‘ng tá»« [cmake.org](https://cmake.org/download/).

## Pháº§n 2: Chuyá»ƒn Ä‘á»•i mÃ´ hÃ¬nh vÃ  lÆ°á»£ng tá»­ hÃ³a

### Chá»n Ä‘á»‹nh dáº¡ng phÃ¹ há»£p

Äá»‘i vá»›i cÃ¡c mÃ´ hÃ¬nh ngÃ´n ngá»¯ nhá» Ä‘Ã£ tinh chá»‰nh, chÃºng tÃ´i khuyáº¿n nghá»‹ sá»­ dá»¥ng **Ä‘á»‹nh dáº¡ng ONNX** vÃ¬:

- ğŸš€ Tá»‘i Æ°u hÃ³a hiá»‡u suáº¥t tá»‘t hÆ¡n
- ğŸ”§ Triá»ƒn khai khÃ´ng phá»¥ thuá»™c vÃ o pháº§n cá»©ng
- ğŸ­ Kháº£ nÄƒng sáºµn sÃ ng cho sáº£n xuáº¥t
- ğŸ“± TÆ°Æ¡ng thÃ­ch Ä‘a ná»n táº£ng

### PhÆ°Æ¡ng phÃ¡p 1: Chuyá»ƒn Ä‘á»•i báº±ng má»™t lá»‡nh (Khuyáº¿n nghá»‹)

Sá»­ dá»¥ng lá»‡nh sau Ä‘á»ƒ chuyá»ƒn Ä‘á»•i trá»±c tiáº¿p mÃ´ hÃ¬nh Ä‘Ã£ tinh chá»‰nh cá»§a báº¡n:

```bash
olive auto-opt \
    --model_name_or_path /path/to/your/finetuned/model \
    --device cpu \
    --provider CPUExecutionProvider \
    --use_model_builder \
    --precision int4 \
    --output_path models/your-model-name/onnx \
    --log_level 1
```

**Giáº£i thÃ­ch tham sá»‘:**
- `--model_name_or_path`: ÄÆ°á»ng dáº«n Ä‘áº¿n mÃ´ hÃ¬nh Ä‘Ã£ tinh chá»‰nh cá»§a báº¡n
- `--device cpu`: Sá»­ dá»¥ng CPU Ä‘á»ƒ tá»‘i Æ°u hÃ³a
- `--precision int4`: Sá»­ dá»¥ng lÆ°á»£ng tá»­ hÃ³a INT4 (giáº£m kÃ­ch thÆ°á»›c khoáº£ng 75%)
- `--output_path`: ÄÆ°á»ng dáº«n Ä‘áº§u ra cho mÃ´ hÃ¬nh Ä‘Ã£ chuyá»ƒn Ä‘á»•i

### PhÆ°Æ¡ng phÃ¡p 2: Sá»­ dá»¥ng tá»‡p cáº¥u hÃ¬nh (DÃ nh cho ngÆ°á»i dÃ¹ng nÃ¢ng cao)

Táº¡o má»™t tá»‡p cáº¥u hÃ¬nh cÃ³ tÃªn `finetuned_conversion_config.json`:

```json
{
    "input_model": {
        "type": "HfModel",
        "model_path": "/path/to/your/finetuned/model",
        "task": "text-generation"
    },
    "systems": {
        "local_system": {
            "type": "LocalSystem",
            "accelerators": [
                {
                    "execution_providers": [
                        "CPUExecutionProvider"
                    ]
                }
            ]
        }
    },
    "passes": {
        "builder": {
            "type": "ModelBuilder",
            "config": {
                "precision": "int4",
                "quantization_config": {
                    "block_size": 128,
                    "is_symmetric": false
                }
            }
        }
    },
    "host": "local_system",
    "target": "local_system",
    "cache_dir": "cache",
    "output_dir": "models/output/your-finetuned-model-onnx"
}
```

Sau Ä‘Ã³ cháº¡y:

```bash
olive run --config ./finetuned_conversion_config.json
```

### So sÃ¡nh cÃ¡c tÃ¹y chá»n lÆ°á»£ng tá»­ hÃ³a

| Äá»™ chÃ­nh xÃ¡c | KÃ­ch thÆ°á»›c tá»‡p | Tá»‘c Ä‘á»™ suy luáº­n | Cháº¥t lÆ°á»£ng mÃ´ hÃ¬nh | Sá»­ dá»¥ng khuyáº¿n nghá»‹ |
|--------------|----------------|-----------------|--------------------|---------------------|
| FP16         | Baseline Ã— 0.5 | Nhanh           | Tá»‘t nháº¥t          | Pháº§n cá»©ng cao cáº¥p  |
| INT8         | Baseline Ã— 0.25 | Ráº¥t nhanh       | Tá»‘t               | Lá»±a chá»n cÃ¢n báº±ng  |
| INT4         | Baseline Ã— 0.125 | Nhanh nháº¥t      | Cháº¥p nháº­n Ä‘Æ°á»£c    | Háº¡n cháº¿ tÃ i nguyÃªn |

ğŸ’¡ **Khuyáº¿n nghá»‹**: Báº¯t Ä‘áº§u vá»›i lÆ°á»£ng tá»­ hÃ³a INT4 cho láº§n triá»ƒn khai Ä‘áº§u tiÃªn cá»§a báº¡n. Náº¿u cháº¥t lÆ°á»£ng khÃ´ng Ä‘áº¡t yÃªu cáº§u, hÃ£y thá»­ INT8 hoáº·c FP16.

## Pháº§n 3: Cáº¥u hÃ¬nh triá»ƒn khai Foundry Local

### Táº¡o cáº¥u hÃ¬nh mÃ´ hÃ¬nh

Äi Ä‘áº¿n thÆ° má»¥c mÃ´ hÃ¬nh cá»§a Foundry Local:

```bash
foundry cache cd ./models/
```

Táº¡o cáº¥u trÃºc thÆ° má»¥c mÃ´ hÃ¬nh cá»§a báº¡n:

```bash
mkdir -p ./models/custom/your-finetuned-model
```

Táº¡o tá»‡p cáº¥u hÃ¬nh `inference_model.json` trong thÆ° má»¥c mÃ´ hÃ¬nh cá»§a báº¡n:

```json
{
  "Name": "your-finetuned-model-int4",
  "Description": "Fine-tuned quantized model",
  "Version": "1.0",
  "PromptTemplate": {
    "system": "<|im_start|>system\n{Content}<|im_end|>",
    "user": "<|im_start|>user\n{Content}<|im_end|>",
    "assistant": "<|im_start|>assistant\n{Content}<|im_end|>",
    "prompt": "<|im_start|>user\n{Content}<|im_end|>\n<|im_start|>assistant"
  },
  "ModelConfig": {
    "max_length": 2048,
    "temperature": 0.7,
    "top_p": 0.9,
    "repetition_penalty": 1.1
  }
}
```

### Cáº¥u hÃ¬nh máº«u dÃ nh riÃªng cho mÃ´ hÃ¬nh

#### Äá»‘i vá»›i cÃ¡c mÃ´ hÃ¬nh dÃ²ng Qwen:

```json
{
  "Name": "qwen-finetuned-int4",
  "PromptTemplate": {
    "system": "<|im_start|>system\n{Content}<|im_end|>",
    "user": "<|im_start|>user\n{Content}<|im_end|>",
    "assistant": "<|im_start|>assistant\n{Content}<|im_end|>",
    "prompt": "<|im_start|>user\n{Content}<|im_end|>\n<|im_start|>assistant"
  }
}
```

## Pháº§n 4: Kiá»ƒm tra vÃ  tá»‘i Æ°u hÃ³a mÃ´ hÃ¬nh

### XÃ¡c minh cÃ i Ä‘áº·t mÃ´ hÃ¬nh

Kiá»ƒm tra xem Foundry Local cÃ³ nháº­n diá»‡n Ä‘Æ°á»£c mÃ´ hÃ¬nh cá»§a báº¡n khÃ´ng:

```bash
foundry cache ls
```

Báº¡n sáº½ tháº¥y `your-finetuned-model-int4` trong danh sÃ¡ch.

### Báº¯t Ä‘áº§u kiá»ƒm tra mÃ´ hÃ¬nh

```bash
foundry model run your-finetuned-model-int4
```

### ÄÃ¡nh giÃ¡ hiá»‡u suáº¥t

Theo dÃµi cÃ¡c chá»‰ sá»‘ chÃ­nh trong quÃ¡ trÃ¬nh kiá»ƒm tra:

1. **Thá»i gian pháº£n há»“i**: Äo thá»i gian trung bÃ¬nh cho má»—i pháº£n há»“i
2. **Sá»­ dá»¥ng bá»™ nhá»›**: Theo dÃµi má»©c tiÃªu thá»¥ RAM
3. **Sá»­ dá»¥ng CPU**: Kiá»ƒm tra táº£i cá»§a bá»™ xá»­ lÃ½
4. **Cháº¥t lÆ°á»£ng Ä‘áº§u ra**: ÄÃ¡nh giÃ¡ má»©c Ä‘á»™ liÃªn quan vÃ  máº¡ch láº¡c cá»§a pháº£n há»“i

### Danh sÃ¡ch kiá»ƒm tra xÃ¡c nháº­n cháº¥t lÆ°á»£ng

- âœ… MÃ´ hÃ¬nh pháº£n há»“i phÃ¹ há»£p vá»›i cÃ¡c truy váº¥n trong lÄ©nh vá»±c Ä‘Ã£ tinh chá»‰nh
- âœ… Äá»‹nh dáº¡ng pháº£n há»“i khá»›p vá»›i cáº¥u trÃºc Ä‘áº§u ra mong Ä‘á»£i
- âœ… KhÃ´ng cÃ³ rÃ² rá»‰ bá»™ nhá»› trong quÃ¡ trÃ¬nh sá»­ dá»¥ng kÃ©o dÃ i
- âœ… Hiá»‡u suáº¥t á»•n Ä‘á»‹nh vá»›i cÃ¡c Ä‘á»™ dÃ i Ä‘áº§u vÃ o khÃ¡c nhau
- âœ… Xá»­ lÃ½ Ä‘Ãºng cÃ¡c trÆ°á»ng há»£p ngoáº¡i lá»‡ vÃ  Ä‘áº§u vÃ o khÃ´ng há»£p lá»‡

## TÃ³m táº¯t

ChÃºc má»«ng! Báº¡n Ä‘Ã£ hoÃ n thÃ nh:

- âœ… Chuyá»ƒn Ä‘á»•i Ä‘á»‹nh dáº¡ng mÃ´ hÃ¬nh Ä‘Ã£ tinh chá»‰nh
- âœ… Tá»‘i Æ°u hÃ³a lÆ°á»£ng tá»­ hÃ³a mÃ´ hÃ¬nh
- âœ… Cáº¥u hÃ¬nh triá»ƒn khai Foundry Local
- âœ… Tinh chá»‰nh hiá»‡u suáº¥t vÃ  kháº¯c phá»¥c sá»± cá»‘

---

**TuyÃªn bá»‘ miá»…n trá»« trÃ¡ch nhiá»‡m**:  
TÃ i liá»‡u nÃ y Ä‘Ã£ Ä‘Æ°á»£c dá»‹ch báº±ng dá»‹ch vá»¥ dá»‹ch thuáº­t AI [Co-op Translator](https://github.com/Azure/co-op-translator). Máº·c dÃ¹ chÃºng tÃ´i cá»‘ gáº¯ng Ä‘áº£m báº£o Ä‘á»™ chÃ­nh xÃ¡c, xin lÆ°u Ã½ ráº±ng cÃ¡c báº£n dá»‹ch tá»± Ä‘á»™ng cÃ³ thá»ƒ chá»©a lá»—i hoáº·c khÃ´ng chÃ­nh xÃ¡c. TÃ i liá»‡u gá»‘c báº±ng ngÃ´n ngá»¯ báº£n Ä‘á»‹a nÃªn Ä‘Æ°á»£c coi lÃ  nguá»“n thÃ´ng tin chÃ­nh thá»©c. Äá»‘i vá»›i cÃ¡c thÃ´ng tin quan trá»ng, khuyáº¿n nghá»‹ sá»­ dá»¥ng dá»‹ch vá»¥ dá»‹ch thuáº­t chuyÃªn nghiá»‡p bá»Ÿi con ngÆ°á»i. ChÃºng tÃ´i khÃ´ng chá»‹u trÃ¡ch nhiá»‡m vá» báº¥t ká»³ sá»± hiá»ƒu láº§m hoáº·c diá»…n giáº£i sai nÃ o phÃ¡t sinh tá»« viá»‡c sá»­ dá»¥ng báº£n dá»‹ch nÃ y.